\documentclass[12pt]{article}

\usepackage{fixltx2e}
\usepackage{textcomp}
\usepackage[cm]{fullpage}
\usepackage{amsfonts}
\usepackage{verbatim}
\usepackage[english]{babel}
\usepackage{pifont}
\usepackage{color}
\usepackage{setspace}
\usepackage{lscape}
\usepackage{indentfirst}
\usepackage[normalem]{ulem}
\usepackage{booktabs}
% \usepackage{nag}
\usepackage{natbib}
% \usepackage{bibtex}
\usepackage{float}
\usepackage{latexsym}
\usepackage{hyperref}
\usepackage{url}
% \usepackage{html}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{array}
%\usepackage{mhchem}
\usepackage{ifthen}
\usepackage{caption}
\usepackage{xcolor}
\usepackage{amsthm}
\usepackage{amstext}
\usepackage{nicefrac}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage[scientific-notation=true]{siunitx}
\usepackage{subfigure}
\usepackage[flushleft]{threeparttable}
\usepackage{lineno}
\usepackage{adjustbox}
\usepackage{ragged2e}
\usepackage{authblk}
\usepackage{multirow}
\usepackage[T1]{fontenc}

\setlength{\parskip}{1em}
\renewcommand{\baselinestretch}{2.0}
\renewcommand\Affilfont{\small}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\thealgorithm}{S\arabic{algorithm}}

\newcommand\ontop[2]{\genfrac{}{}{0pt}{}{#1}{#2}}

\begin{document}

\title{Supplementary material for StarBEAST2}
\author[1,2]{Huw A. Ogilvie\thanks{huw.ogilvie@anu.edu.au}}
\author[2,3]{Remco R. Bouckaert}
\author[2,3]{Alexei J. Drummond}
\affil[1]{Division of Ecology and Evolution, Research School of Biology, Australian National University, Canberra, Australia}
\affil[2]{Centre for Computational Evolution, University of Auckland, Auckland, New Zealand}
\affil[3]{Department of Computer Science, University of Auckland, Auckland, New Zealand}

\maketitle

\clearpage

\section{Supplementary figures}

\justifying

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{species_topology_frequencies.pdf}
\caption
{Frequency of five-taxon species tree topologies sampled from a birth-death prior
distribution. Topologies were sampled by simulating trees using biopy (red), or
by using a StarBEAST2 MCMC chain (blue). Frequencies are identical apart from
noise, indicating that StarBEAST2 is mathematically correct. Three levels of
probability are evident from left to right --- high probability balanced
topologies e.g. ((a,b),((c,d),e)), middle probability intermediate topologies
e.g. (((a,b),(c,d)),e), and low probability unbalanced topologies e.g.
((((a,b),c),d),e).}
\label{fig:speciesTopologyFrequencies}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{gene_topology_frequencies.pdf}
\caption
{Frequency of five-taxon gene tree topologies sampled from a multispecies
coalescent prior distribution. Topologies were sampled by simulating gene trees
within species trees using biopy (red), or by using a StarBEAST2 MCMC chain
(blue). Gene trees were sampled with two clock rates, 0.5 (circles) and 2.0
(triangles), although clock rate should not affect topology or node heights in
units of time. Frequencies are identical apart from noise, indicating that
StarBEAST2 is mathematically correct. Three levels of probability are evident
from left to right --- high probability balanced topologies e.g.
((a,b),((c,d),e)), middle probability intermediate topologies e.g.
(((a,b),(c,d)),e), and low probability unbalanced topologies e.g.
((((a,b),c),d),e).}
\label{fig:geneTopologyFrequencies}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{species_node_heights.pdf}
\caption
{Probability densities of five-taxon species tree node heights sampled from a
birth-death prior distribution. Node heights were sampled by simulating trees
using biopy (red), or by using a StarBEAST2 MCMC chain (blue). Probability
densities are plotted separately for each ranked node giving four peaks, one
for each internal node. Node height probability densities are identical apart
from noise, indicating that StarBEAST2 is mathematically correct.}
\label{fig:speciesNodeHeights}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{gene_node_heights.pdf}
\caption
{Probability densities of five-taxon gene tree node heights sampled from a
multispecies coalescent prior distribution. Node heights were sampled by
simulating gene trees within species trees using biopy (red), or by using a
StarBEAST2 MCMC chain (blue). Gene trees were sampled with two clock rates, 0.5
and 2.0, and node heights from both sets of gene trees were combined as clock
rate should not affect topology or node heights in units of time. Probability
densities are plotted separately for each ranked node giving four peaks, one for
each internal node. Node height probability densities are identical apart from
noise, indicating that StarBEAST2 is mathematically correct.}
\label{fig:geneNodeHeights}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{gene_branch_rates.pdf}
\caption
{Probability densities of five-taxon gene tree branch rates produced by a
species tree uncorrelated lognormal (UCLN) relaxed clock. Branch rates were
sampled by simulating gene trees within species trees using biopy and simulating
species tree branch rates using scipy (red), or by using a StarBEAST2 MCMC chain
(blue). Gene trees were sampled with two clock rates, 0.5 and 2.0, resulting in
two peaks. Branch rate probability densities are identical apart from noise,
indicating that StarBEAST2 is mathematically correct.}
\label{fig:geneBranchRatesUCLD}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{exp_gene_branch_rates.pdf}
\caption
{Probability densities of five-taxon gene tree branch rates produced by a
species tree uncorrelated exponential (UCED) relaxed clock. Branch rates were
sampled by simulating gene trees within species trees using biopy and simulating
species tree branch rates using scipy (red), or by using a StarBEAST2 MCMC chain
(blue). Gene trees were sampled with two clock rates, 0.5 and 2.0, resulting in
two peaks. Branch rate probability densities are identical apart from noise,
indicating that StarBEAST2 is mathematically correct.}
\label{fig:geneBranchRatesUCED}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=70mm]{false_branch_rates.pdf}
\caption
{Number of erroneous per-species substitution rates estimated using BEAST concatenation and StarBEAST2. Erroneous
branch rates are those with 95\% highest posterior density (HPD) credible intervals which do not include the true rate of 1.
Numbers above a branch are the counts of erroneous branches for concatenation, and those
below are the counts for StarBEAST2, both out of 96 replicates. The first count is
the number of branch rates inferred to be faster than 1, and the
second is the number inferred to be slower than 1.}
\label{fig:spilsBranchRates}
\end{figure}

\begin{figure}[htb!]
\centering
\includegraphics[width=70mm]{false_branch_lengths.pdf}
\caption
{Number of erroneous branch lengths estimated using BEAST concatenation and StarBEAST2. Erroneous
branch lengths are those with 95\% highest posterior density (HPD) credible intervals which do not include the true simulated length for a given branch.
Numbers above a branch are the counts of erroneous branches for concatenation, and those
below are the counts for StarBEAST2, both out of 96 replicates. The first count is
the number of branch lengths inferred to be longer than the true length, and the
second is the number inferred to be shorter.}
\label{fig:spilsBranchLengths}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{mstates_per_hour.pdf}
\caption
{Impact of operators, population size integration and clock models on
the calculation time for each state. Topology refers to the
replacement of na\"ive nearest-neighbor interchange and subtree prune and
regraft operators with coordinated operators. Height refers to the addition of
operators which make coordinated changes to node heights. Uncorrelated
log-normal relaxed clocks were applied to either each gene tree (GT-UCLN) or to
the species tree (ST-UCLN). N = 30.}
\label{fig:mstatesPerHour}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{branch_length_accuracy_unphased.pdf}
\caption
{Coverage and accuracy of species branch lengths using different methods.
Methods are StarBEAST2, *BEAST and unphased BEAST concatenation with uncorrelated
log-normal relaxed clocks applied to each gene tree (GT-UCLN) or to the species
tree (ST-UCLN). (A,B) The percentages of true branch lengths present within the
corresponding 95\% highest posterior density (HPD) credible intervals. (C,D)
The difference between the sum of estimated branch lengths and the sum of true
branch lengths as a percentage of the sum of true branch lengths. (E,F) The
sum of absolute differences between estimated and simulated branch lengths as
a percentage of true tree length. N = 30.}
\label{fig:branchLengthsError}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=70mm]{topology_accuracy_unphased.pdf}
\caption
{Coverage and accuracy of species tree topologies using different methods.
Methods are StarBEAST2, *BEAST and unphased BEAST concatenation with uncorrelated
log-normal relaxed clocks applied to each gene tree (GT-UCLN) or to the species
tree (ST-UCLN). (A) The percentage of true species tree topologies within the
95\% credible set of topologies. (B) The average rooted Robinson-Foulds (RF)
distance between the maximum clade credibility (MCC) species tree topology and
the simulated true topology. Error bars are 95\% confidence intervals
calculated by bootstrapping. N = 30.}
\label{fig:treeTopologyError}
\end{figure}

\clearpage

\begin{figure}[htb!]
\centering
\includegraphics[width=70mm]{branch_rates_unphased.pdf}
\caption
{Estimates of species tree branch rates using unphased BEAST concatenation versus
StarBEAST2. Estimated rates are the posterior expectations of each branch rate
from each replicate. Root branch rates, which were fixed at 1, were excluded.
In blue are simple linear regression lines of best fit, and in red are the $y
= x$ lines showing a perfect relationship between estimates and truth. N = 30.}
\label{fig:branchRates}
\end{figure}

\clearpage

\section{Supplementary tables}

\begin{table}[htb!]
\centering
\caption{Key for tested configurations.}
\label{tab:configurationKey}
\begin{threeparttable}
\begin{adjustbox}{center}
\begin{tabular}{|c|c|c|c|c|c|c|}
\hline
Key & Method & Clock model & Co-ops & Popsizes & Loci & DNA\tabularnewline
\hline
beast-1x-00 & Concatenation & Strict & NA & NA & 26 & Phased\tabularnewline
\hline
beast-1x-01 & Concatenation & Strict & NA & NA & 26 & Unphased\tabularnewline
\hline
beast-1x-20 & Concatenation & ST-UCLN & NA & NA & 26 & Phased\tabularnewline
\hline
beast-1x-21 & Concatenation & ST-UCLN & NA & NA & 26 & Unphased\tabularnewline
\hline
beast-5x-00 & Concatenation & Strict & NA & NA & 130 & Phased\tabularnewline
\hline
beast-5x-01 & Concatenation & Strict & NA & NA & 130 & Unphased\tabularnewline
\hline
beast-5x-20 & Concatenation & ST-UCLN & NA & NA & 130 & Phased\tabularnewline
\hline
beast-5x-21 & Concatenation & ST-UCLN & NA & NA & 130 & Unphased\tabularnewline
\hline
starbeast1-1x-00 & *BEAST & Strict & Neither & MCMC & 26 (50) & Phased\tabularnewline
\hline
starbeast1-1x-10 & *BEAST & GT-UCLN & Neither & MCMC & 26 (50) & Phased\tabularnewline
\hline
starbeast2-1x-00 & StarBEAST2 & Strict & Neither & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-01 & StarBEAST2 & Strict & Neither & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-02 & StarBEAST2 & Strict & Heights & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-03 & StarBEAST2 & Strict & Heights & Analytical & 26 (50) & Phased\tabularnewline
\hline
starbeast2-1x-04 & StarBEAST2 & Strict & Topology & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-05 & StarBEAST2 & Strict & Topology & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-06 & StarBEAST2 & Strict & Both & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-07 & StarBEAST2 & Strict & Both & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-10 & StarBEAST2 & GT-UCLN & Neither & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-11 & StarBEAST2 & GT-UCLN & Neither & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-12 & StarBEAST2 & GT-UCLN & Heights & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-13 & StarBEAST2 & GT-UCLN & Heights & Analytical & 26 (50) & Phased\tabularnewline
\hline
starbeast2-1x-14 & StarBEAST2 & GT-UCLN & Topology & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-15 & StarBEAST2 & GT-UCLN & Topology & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-16 & StarBEAST2 & GT-UCLN & Both & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-17 & StarBEAST2 & GT-UCLN & Both & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-20 & StarBEAST2 & ST-UCLN & Neither & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-21 & StarBEAST2 & ST-UCLN & Neither & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-22 & StarBEAST2 & ST-UCLN & Heights & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-23 & StarBEAST2 & ST-UCLN & Heights & Analytical & 26 (50) & Phased\tabularnewline
\hline
starbeast2-1x-24 & StarBEAST2 & ST-UCLN & Topology & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-25 & StarBEAST2 & ST-UCLN & Topology & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-1x-26 & StarBEAST2 & ST-UCLN & Both & MCMC & 26 & Phased\tabularnewline
\hline
starbeast2-1x-27 & StarBEAST2 & ST-UCLN & Both & Analytical & 26 & Phased\tabularnewline
\hline
starbeast2-2x-03 & StarBEAST2 & Strict & Heights & Analytical & 52 (100) & Phased\tabularnewline
\hline
starbeast2-2x-13 & StarBEAST2 & GT-UCLN & Heights & Analytical & 52 (100) & Phased\tabularnewline
\hline
starbeast2-2x-23 & StarBEAST2 & ST-UCLN & Heights & Analytical & 52 (100) & Phased\tabularnewline
\hline
\end{tabular}
\end{adjustbox}
\begin{tablenotes}
\item Loci numbers in brackets are for \textit{Crocidura} reanalyses
\end{tablenotes}
\end{threeparttable}
\end{table}

\begin{landscape}

\begin{table}[htb!]
\centering
\caption{Ln(ESS per hour) convergence for simulated data.}
\label{tab:simulatedPerHour}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{21-species.ess_per_hour.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\clearpage

\begin{table}[htb!]
\centering
\caption{Ln(ESS per million states) convergence for simulated data.}
\label{tab:simulatedPerMstates}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{21-species.ess_per_mstates.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\clearpage

\begin{table}[htb!]
\centering
\caption{Ln(ESS per hour) convergence for \textit{Pseudacris} chorus frogs.}
\label{tab:pseudacrisPerHour}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{pseudacris.ess_per_hour.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\clearpage

\begin{table}[htb!]
\centering
\caption{Ln(ESS per million states) convergence for \textit{Pseudacris} chorus frogs.}
\label{tab:pseudacrisPerMstates}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{pseudacris.ess_per_mstates.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\clearpage

\begin{table}[htb!]
\centering
\caption{Ln(ESS per hour) convergence for \textit{Crocidura} shrews.}
\label{tab:crociduraPerHour}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{crocidura.ess_per_hour.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\begin{table}[htb!]
\centering
\caption{Ln(ESS per million states) convergence for \textit{Crocidura} shrews.}
\label{tab:crociduraPeMstates}
\begin{threeparttable}
\begin{adjustbox}{center}
\renewcommand{\arraystretch}{1.5}
\tiny
\input{crocidura.ess_per_mstates.tex}
\end{adjustbox}
\begin{tablenotes}
\tiny
\item All values are mean(Ln(ESS rate)) $\pm$ sd(Ln(ESS rate))
\item The configuration for each key is described by Table~\ref{tab:configurationKey}
\end{tablenotes}
\end{threeparttable}
\end{table}

\clearpage

\end{landscape}

\begin{table}[htb!]
\centering
\caption{Initial chain lengths and sampling rates.}
\label{tab:chainLengths}
\begin{threeparttable}
\begin{adjustbox}{center}
\begin{tabular}{|l|r|r|}
\hline
Methods & Initial chain length & Sampling rate (one per)\tabularnewline
\hline
Concatenation 26 loci phased & $2^{23} = 8388608$ & $2^{10} = 1024$\tabularnewline
\hline
Concatenation 26 loci unphased & $2^{22} = 4194304$ & $2^{9} = 512$\tabularnewline
\hline
Concatenation 130 loci phased & $2^{21} = 2097152$ & $2^{8} = 256$\tabularnewline
\hline
Concatenation 130 loci unphased & $2^{20} = 1048576$ & $2^{7} = 128$\tabularnewline
\hline
*BEAST 26 loci & $2^{24} = 16777216$ & $2^{11} = 2048$\tabularnewline
\hline
StarBEAST2 26 loci & $2^{24} = 16777216$ & $2^{11} = 2048$\tabularnewline
\hline
StarBEAST2 52 loci & $2^{23} = 8388608$ & $2^{10} = 1024$\tabularnewline
\hline
StarBEAST2 50 loci -- \textit{Crocidura} & $2^{24} = 16777216$ & $2^{11} = 2048$\tabularnewline
\hline
StarBEAST2 100 loci -- \textit{Crocidura} & $2^{23} = 8388608$ & $2^{10} = 1024$\tabularnewline
\hline
\end{tabular}
\end{adjustbox}
\end{threeparttable}
\end{table}

\clearpage

\section{CoordinatedUniform proposal example}

The CoordinatedUniform operator will pick one non-leaf, non-root species tree
node uniformly at random to be moved, dubbed $S$. Given a species tree with
the topology ((A,B),C),D there are two non-leaf, non-root nodes: the common
ancestor of species A and B (AB) and the common ancestor of species A, B and C
(ABC). We illustrate an example where the ABC node is chosen
(Figure~\ref{fig:coordinatedUniform}).

\begin{figure}[htb!]
\centering
\includegraphics[width=130mm]{coordinated_uniform.pdf}
\caption
{Illustration of the CoordinatedUniform move. An example gene tree is embedded
within a four-taxon asymmetric species tree. Internal gene tree nodes
are numbered, species leaves lettered. The ABC node is represented by a star
in the middle step. Dashed lines are connected component and ABC
node child and parent branches.}
\label{fig:coordinatedUniform}
\end{figure}

The step after selecting a species tree node is to determine which internal
gene tree nodes will also be moved. CoordinatedUniform moves every gene tree
node $s$ in every gene tree which meets all of the following requirements:

\begin{enumerate}
\item at least one descendant individual of $s$ is also a
descendant individual of the \textit{left} child of $S$
\item at least one descendant individual of $s$ is also a
descendant individual of the \textit{right} child of $S$
\item all descendent individuals of $s$ are also
descendent individuals of $S$
\end{enumerate}

Descendent individuals of a gene tree node $s$ are gene tree leaf nodes which
have $s$ as an ancestor. Descendent individuals of a species tree node $S$ are
gene tree leaf nodes belonging to any extant species which has $S$ as an
ancestor. In the example, the left child of $S$ is the AB node, and the right
child of $S$ is the C node. The following internal nodes in the gene tree meet
requirement (1) 12, 13, 14, 15, 16, 20, 22; requirement (2) 13, 16, 17, 21,
22; and requirement (3) 12, 13, 14, 15, 16, 17, 20.

The only nodes in the example meeting all three requirements are 13 and 16.
These nodes are connected by a gene tree branch, making them a single
connected component. The connected component has three child branches (dashed
red, yellow and blue lines) and one parent branch (dashed orange line).

To determine the lower bound for the move, we must first identify the shortest
branch out of all connected component child branches and species tree node $S$
child branches. In the example the connected component child branches have
lengths of 3, 7 and 8.5, and the species tree node child branches have lengths 4
and 6 (Figure~\ref{fig:coordinatedUniform}). The lower bound is therefore the
original species tree node height $t(S) - 3 = 6 - 3 = 3$.

To determine the upper bound we use the shortest branch out of all connected
component parent branches and the species tree node $S$ parent branch. The
parent branch of the single connected component has a length of 2.5, and
the parent branch of $S$ has a length of 4. The upper bound is therefore
$t(S) + 2.5 = 6 + 2.5 = 8.5$.

A new species tree node height $t'(S)$ between 3 and 8.5 is chosen uniformly
at random. Within this range, if the connected component node heights are
changed by $\eta = t'(S) - t(S)$, no topology changes are induced or required.
In our example the new height is 5, so $\eta = 5 - 6.5 = -1.5$. After the
height of the species tree node $S$ and all connected component gene tree
nodes are changed by $\eta = -1.5$ the proposal is complete
(Figure~\ref{fig:coordinatedUniform}).

\end{document}
